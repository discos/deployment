---

- name: Make sure the quicklook service is not running
  service:
    name: quicklook
    status: stopped
  failed_when: false


- name: Install SDTools dependencies
  command: "pip3.6 install {{ item }}"
  with_items:
    - astropy
    - numpy
    - scipy
    - matplotlib
    - pyyaml
    - h5py
    - statsmodels
    - numba
    - watchdog
    - Zdaemon


- name: Create the sdtools directories
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ user }}"
    group: acs
    mode: "{{ item.mode }}"
  with_items:
    - { path: "/{{ discos_sw_dir }}/sdtools", mode: "0710" }
    - { path: "/{{ discos_sw_dir }}/sdtools/quicklook", mode: "0750" }


- name: Copy the sdtools-get template
  template:
    src: sdtools-get
    dest: "/{{ discos_sw_dir }}/sdtools/"
    owner: "{{ user }}"
    group: acs
    mode: 0700
    force: true


- name: Execute the sdtools-get script
  command: ./sdtools-get
  args:
    chdir: "/{{ discos_sw_dir }}/sdtools/"


- name: Copy the quicklook service template
  template:
    src: quicklook
    dest: /etc/rc.d/init.d/quicklook
    mode: 0755
    force: true


- name: Copy the quicklook configuration files
  template:
    src: "{{ item.src }}"
    dest: "/{{ discos_sw_dir }}/sdtools/quicklook/"
    owner: "{{ user }}"
    group: acs
    mode: "{{ item.mode }}"
    force: true
  with_items:
    - { src: "monitor_config.ini", mode: "0640" }
    - { src: "service.sh", mode: "0740" }
    - { src: "service.conf", mode: "0640" }


- name: Make sure the Desktop directory exists for {{ observer }}
  file:
    path: "/{{ discos_sw_dir }}/{{ observer }}/Desktop"
    state: directory
    owner: "{{ observer }}"
    group: acs
    mode: 0755


- name: Create a link to the quicklook index.html page
  file:
    src: "/{{ discos_sw_dir }}/sdtools/quicklook/index.html"
    dest: "/{{ discos_sw_dir }}/{{ observer }}/Desktop/quicklook.html"
    state: link
    force: true
    owner: "{{ user }}"
    group: acs
    mode: 0644
